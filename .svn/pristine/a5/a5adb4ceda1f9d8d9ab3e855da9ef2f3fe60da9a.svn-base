<?php
/* 用登陆、登出、注册、找回密码-商家运营中心
 * @author Bill
 * @data 21080104
 */
namespace app\mcenter\controller;
use think\Controller;
use think\Validate;

class Members extends Controller{
	/* 登陆
	 * @author Bill
	 * @date 2018/01/09
	 */
	public function index(){
		$mid = session('mid');
		if(!empty($mid)){
			$this->redirect(url('goods/index'));
		}
        return view();
    }
    
    public function login(){
    	$mid = session('mid');
    	//已登陆
    	if(!empty($mid)){
    		return ['status'=>200,'msg'=>url('category/index')];
    	}
    	//限定需AJAX请求
    	if (!Request()->isAjax()){
    		return ['status'=>220,'msg'=>'非法请求！'];
    	}

		$rule = [
				['username','require|length:2,20|chsDash|token:__hash__','请输入用户名/手机号|用户名/手机号格式不正确|用户名/手机号格式不正确|页面过期！请刷新重试'],
				['password','require|min:5','请输入密码|密码格式不正确']
		];

		$data = request()->post();
		$validate = new Validate($rule);
		$result   = $validate->check($data);
		if(!$result){
			return ['status'=>201,'msg'=>$validate->getError()];
		}

		$username =  $data['username'];
		$password =  $data['password'];
		$captcha = $data['captcha'];
		$remeber = $data['remeber'];
        
        if(empty($username)){
        	return ['status'=>201,'msg'=>'帐号不能为空！'];
        }
        if(empty($password)){
        	return ['status'=>201,'msg'=>'密码不能为空！'];
        }
        if(empty($captcha)){
        	return ['status'=>201,'msg'=>'验证码不能为空！'];
        }
        if(!captcha_check($captcha)){
        	return ['status'=>201,'msg'=>'验证码不正确！'];
        };
        
        $time = date('Y-m-d H:i:s');
        //获取登录用户ip
        $ip = get_client_ip();
        $uLoginArr = array();
        $uLoginArr['username'] = $username;
        $uLoginArr['login_ip']=$ip;
        $uLoginArr['create_time'] = $time;
        
        //查询用户信息
		$userInfo = array();
//        $userInfo = db('manages')->where('user_name',$username)
//        					->where('status',1)
//        					->find();
		$userInfo = db('manages')->where("status=:id and user_name=:name")
				->bind(['id'=>[1,\PDO::PARAM_INT],'name'=>$username])->find();
        if(empty($userInfo)){
        	return ['status'=>210,'msg'=>'用户不存在！'];
        }

		if($userInfo['user_loginpass'] ==  md5($password) ){
        	/*
        	 * 记住我的COOKIE
        	*/
        	if ($remeber == 'on') {
        		$userNew = base64_encode(json_encode(array('username' => Encrypt($username),'password' => Encrypt($password))));
        		cookie('zcUser',$userNew,array('expire'=>86400 * 10)); // 指定cookie保存时间
        	}
        
        	//注销无用数据
        	unset($userInfo['password']);
        	unset($userInfo['random']);
        	
//        	//用户有效官网信息
//        	$fieldStr = 'web_no,mweb,title,config';
//        	//管理员子账户
//        	if($userInfo['type'] == 2){
//				//查询父账号的 mid
//        		$userPInfo = db('member')->where('my_invite_code',$userInfo['invite_code'])->where('status',1)->find();
//        		$userWeb = db('member_web')->field($fieldStr)->where('mid',$userPInfo['mid'])->where('end_day','gt',date('Y-m-d'))->select();
//        	//管理员账号
//        	}else{
//        		$userWeb = db('member_web')->field($fieldStr)->where('mid',$userInfo['mid'])->where('end_day','gt',date('Y-m-d'))->select();
//        	}
//
//        	$webInf = array();
//        	foreach ($userWeb as $v){
//        		//$v['config'] = json_decode(base64_decode($v['config']),true);
//        		//实时查询最新导航
//        		$v['config'] = get_web_nav($v['web_no']);
//        		$webInf[$v['web_no']] = $v;
//        	}
//        	$userInfo['webInf'] = $webInf;

        	//session生成
        	session('mid',$userInfo['userid']);
        	session('userInfo',$userInfo);
        	//session('userTemp',$userTemp);
        
        	//**************操作记录******************
        	$uLoginArr['mid'] = $userInfo['userid'];
        	$uLoginArr['status'] = 1;
	        $uLoginArr['remark'] = '登录成功';
	        // 添加单条数据
	        db('member_login_log')->insert($uLoginArr);
        	//*****************************************
	        return ['status'=>200,'msg'=>url('goods/index')];
        }else{
	        $uLoginArr['status'] = 1;
	        $uLoginArr['remark'] = '登录失败';
	        // 添加单条数据
	        db('member_login_log')->insert($uLoginArr);
	        return ['status'=>210,'msg'=>'密码不正确！'];
        }
    }
    
    /*登出
     * @author Bill
    * @date 2016/12/20
    */
    public function logout(){
    	//限定需AJAX请求
    	if (!Request()->isAjax()){
    		//return ['status'=>220,'msg'=>'非法请求！'];
    	}
    	// 清空当前的session
    	session(null);
    	//删除自动登陆cookie值
    	//cookie('thdUser',null);
    	$this->redirect(url('members/index'));
    	//$this->success('退出成功', 'members/index');
    }

	public function logouts(){
		// 清空当前的session
		session(null);
		//删除自动登陆cookie值
		//cookie('thdUser',null);
		$this->redirect(url('members/index'));
		//$this->success('退出成功', 'members/index');
	}
    
    
    /******************************** 注册 **********************
     * @author Bill
     * @date 2017/04/14
     */
    public function reg(){
    	$mid = session('mid');
    	if(!empty($mid)){
    		$this->redirect(url('ucenter/index'));
    	}
    	return view();
    }
    
    /*注册处理
     * @author Bill
     * @date 2017/04/14
     */
    public function doreg(){
    	$mid = session('mid');
    	if(!empty($mid)){
    		$this->redirect(url('ucenter/index'));
    	}
    	//限定需AJAX请求
    	if (!Request()->isAjax()){
    		return ['status'=>220,'msg'=>'非法请求！'];
    	}
    	 
    	$username = input('post.username','','addslashes,strip_tags,strtolower');
    	$password = input('post.password','','strip_tags');
    	$captcha = input('post.captcha/s');
    	$remeber = input('post.remeber/s');
    
    	if(empty($username)){
    		return ['status'=>201,'msg'=>'帐号不能为空！'];
    	}
    	if(empty($password)){
    		return ['status'=>201,'msg'=>'密码不能为空！'];
    	}
    	if(empty($captcha)){
    		return ['status'=>201,'msg'=>'验证码不能为空！'];
    	}
    	if(!captcha_check($captcha)){
    		return ['status'=>201,'msg'=>'验证码不正确！'];
    	};
    
    	$time = date('Y-m-d H:i:s');
    	//获取登录用户ip
    	$ip = get_client_ip();
    	$uLoginArr = array();
    	$uLoginArr['username'] = $username;
    	$uLoginArr['login_ip']=$ip;
    	$uLoginArr['addtime'] = $time;
    
    	//查询用户信息
		$userInfo = array();
    	$userInfo = db('member')->where('username|phone',$username)
    	->where('status',1)
    	->find();
    
    	$random = Decrypt($userInfo['random']);
    	if(md5(md5($password).$random) == $userInfo['password']){
    		/*
    		 * 记住我的COOKIE
    		*/
    		if ($remeber == 'on') {
    			$userNew = base64_encode(json_encode(array('username' => Encrypt($username),'password' => Encrypt($password))));
    			cookie('zcUser',$userNew,array('expire'=>86400 * 10)); // 指定cookie保存时间
    		}
    
    		//注销无用数据
    		unset($userInfo['password']);
    		unset($userInfo['random']);
    
    		//用户昵称及头像信息   信息已经放入user表
    		//$userTemp = db('member_templates')->where('mid',$userInfo['mid'])->find();
    
    		//session生成
    		session('mid',$userInfo['mid']);
    		session('userInfo',$userInfo);
    		//session('userTemp',$userTemp);
    
    		//**************操作记录******************
    		$uLoginArr['mid'] = $userInfo['mid'];
    		$uLoginArr['status'] = 1;
    		$uLoginArr['remark'] = '登录成功';
    		// 添加单条数据
    		db('member_login_log')->insert($uLoginArr);
    		//*****************************************
    		return ['status'=>200,'msg'=>url('ucenter/index')];
    	}else{
    		$uLoginArr['status'] = 1;
    		$uLoginArr['remark'] = '登录失败';
    		// 添加单条数据
    		db('member_login_log')->insert($uLoginArr);
    		return ['status'=>210,'msg'=>'用户'];
    	}
    }
}