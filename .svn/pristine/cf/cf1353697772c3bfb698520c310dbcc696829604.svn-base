<?php
/* ??????
 * @author Bill
 * @data 21090218
 */
namespace app\mall\controller;
use think\Controller;

class goods extends Controller{
	public function __construct() {
		//if(isMobile()){
			config('template.view_path','../template/mallm/');
		//}
		parent::__construct();
		$userinfo = session('userinfo');
		if(!empty($userinfo)){
			$this->assign('userinfo',$userinfo);
		}
		//网站SEO标题
		//$this->assign('webSet',get_webset());
	}
	
	/* 商品分类列表
	 * @author Bill
	 * @data 21090219
	 */
	public function index(){
		/*URL key参数
    	 * 域名说明：分类 -排序 - 活动 - 属性1 - 属性2 - 属性3 - ...。
    	 * 多活动'22_23';(活动ID需小于20)
    	 * 多属性查询 '22_23';(属性值ID均大于20)
    	 * 关键字搜索 是 ?k=1233
    	 * 分页是 ?pn=5
    	*/
		$key = request()->route('key');
		$keyArr = explode('-', $key);
		
		//已选属性值
		$attriid = [0];
		foreach ($keyArr as $k=>$v){
			switch ($k) {
				case 0:
				case 1:
					$keyArr[$k] = intval($v);
					break;
				default:
					$keyArr[$k] = explode('_', $v);
					if($k>2){
						$attriid = array_merge($attriid,$keyArr[$k]);
					}
					break;
			}
		}
		
		$this->assign('attriid',$attriid);
		$this->assign('keyArr',$keyArr);
	
		/* //分类是0是全部
		$cid = intval($keyArr[0]);
		//
		$order = isset($keyArr[1])?intval($keyArr[1]):0;
		$order = isset($keyArr[0])?intval($keyArr[0]):0;
		
		
		//格式话URL
		for ($i=0;$i<12;$i++){
			$keyArr[$i] = isset($keyArr[$i])?intval($keyArr[$i]):0;
		}
		if(isset($keyArr[0]) && $keyArr[0]>5){
			if(preg_match("/^\d((\d|~)+)\d$/",$keyArr[0])){
				$keyArr = $keyArr[0];
			}
		} */
		
		//搜索关键字
		$keyword = input('get.k','','addslashes,strip_tags');
		//商品分类
		$cid = intval($keyArr[0]);
		
		$wheres = ['status'=>2];
		if($cid){
			$this->assign('cid',$cid);
			
			$wheres['cid'] = $cid;
			
			//分类属性
			$wheresat = ['cid'=>$cid,'status'=>2];
			$attrlist = db('good_cat_attr')->where($wheresat)->order('weight desc')->select();
			
			foreach($attrlist as $key=>$val){
				//分类属性值
				$wheresati = ['cid'=>$cid,'status'=>2,'attrid'=>$val['id']];
				$attrlist[$key]['attritems'] = db('good_cat_attr_item')->where($wheresati)->order('weight desc')->select();
			}
			
			$this->assign('cid',$cid);
			$this->assign('attrlist',$attrlist);
		}
		
		
		$lists = db('good')->where($wheres)->order('weight DESC')->limit(10)->select();
		$this->assign('lists',$lists);
		return view();
    }
  
    
    
    /* 足迹
     * @author Bill
    * @data 21090622
    */
    public function track(){
    	$userid = session('userid');
    	if(empty($userid)){
    		$this->redirect(url('login/index'));
    	}
    	$wheres = ['collect.type'=>1,'collect.userid'=>$userid];
    	$lists = db('users_collect')->alias('collect')->join('js_good good','collect.gno = good.gno')
    	->where($wheres)->order('collect.id desc')->select();
    	$this->assign('lists',$lists);
    	return view();
    }
    
    /* 商品详情
     * @author Bill
    * @data 21090219
    */
    public function inf(){
    	 //商品图片
    	//$a = ['/images/20190628/kc1.jpg','/images/20190628/kc2.jpg','/images/20190628/kc3.jpg','/images/20190628/kc4.jpg','/images/20190628/kc5.jpg'];
    	//echo base64_encode(json_encode($a));
    	//echo '<br>';
		//$a = ['/images/20190628/ky1.jpg','/images/20190628/ky2.jpg','/images/20190628/ky3.jpg','/images/20190628/ky4.jpg','/images/20190628/ky5.jpg'];
    	//echo base64_encode(json_encode($a));
    	//echo '<br>';
		//$a = [['name'=>'购买'],['name'=>'租借90天'],['name'=>'租借150天']];
    	//echo base64_encode(json_encode($a));
    	/*//商品规格值表
    	$a = [['name'=>'套装'],['name'=>'上装'],['name'=>'长裤']];
    	echo base64_encode(json_encode($a));
    	
    	echo '<br>';
    	$a = [['name'=>'100cm'],['name'=>'110cm'],['name'=>'120cm'],['name'=>'130cm'],['name'=>'140cm'],['name'=>'150cm'],['name'=>'160cm'],['name'=>'170cm'],['name'=>'180cm']];
    	echo base64_encode(json_encode($a)); */
    	
    	
    	$gno = request()->route('id');
    	$wheres = ['gno'=>$gno,'status'=>2];
    	
    	//商品详情
    	$ginf = db('good')->where($wheres)->find();
    	if(empty($ginf)){
    		$this->redirect('http://'.request()->host().'/');
    	}
    	
    	
    	
    	//是否收藏商品
    	$collectgood = 0;
    	$userid = session('userid');
    	if($userid){
	    	//收藏商品
    		$wheres = ['type'=>0,'userid'=>$userid,'gno'=>$gno];
	    	$inf = db('users_collect')->where($wheres)->find();
	    	$collectgood = $inf?1:0;
	    	
	    	//浏览记录
	    	$wheres = ['type'=>1,'userid'=>$userid,'gno'=>$gno];
	    	db('users_collect')->where($wheres)->delete();
	    	//添加
	    	$data = ['userid'=>$userid,'type'=>1,'gno'=>$gno,'addtime'=>date('Y-m-d H:i:s')];
	    	db('users_collect')->insert($data);
    	}
    	$this->assign('collectgood',$collectgood);
    	
    	$wheres = ['gno'=>$gno];
    	$giinf = db('good_inf')->where($wheres)->find();
    	$ginf['desc'] = $giinf['desc'];
    	$this->assign('ginf',$ginf);
    	
    	//商品规格价格
    	$wheres = ['gno'=>$gno,'num'=>['gt',0]];
    	$listcsp = db('good_spec_price')->where($wheres)->select();
    	$this->assign('listcsp',$listcsp);
    	
    	//分类规格
    	$wheres = ['cid'=>$ginf['cid'],'status'=>2];
    	$listcs = db('good_cat_spec')->field('id,name')->where($wheres)->order('weight DESC')->select();
    	
    	//$this->assign('listcs',$listcs);
    	
    	//商品规格值
    	$wheres = ['gno'=>$gno];
    	$listcsi = db('good_cat_spec_item')->where($wheres)->select();
    	//$this->assign('listcsi',$listcsi);
    	
    	//商品规格值统计
    	$gspec = ['maxp'=>0,'minp'=>$listcsp[0]['price'],'maxgp'=>0,'mingp'=>$listcsp[0]['gprice'],'num'=>0];
    	//最大/最小售价,库存
    	foreach($listcsp as $v){
    		if($gspec['maxp']<$v['price']){
    			$gspec['maxp'] = $v['price'];
    		}
    		if($gspec['minp']>$v['price']){
    			$gspec['minp'] = $v['price'];
    		}
    		//拼团价
    		if($gspec['maxgp']<$v['gprice']){
    			$gspec['maxgp'] = $v['gprice'];
    		}
    		if($gspec['mingp']>$v['gprice']){
    			$gspec['mingp'] = $v['gprice'];
    		}
    		$gspec['num'] += $v['num'];
    	}
    	$this->assign('gspec',$gspec);
    	
    	
    	//商品规格值
    	$spec = [];
    	foreach ($listcs as $val){
    		$onespec = ['name'=>$val['name']];
    		foreach ($listcsi as $v){
    			if($val['id'] == $v['specid']){
    				$onespec['items'] = json_decode(base64_decode($v['item']),true);
    			}
    			
    		}
    		$spec[] = $onespec;
    	}
    	$this->assign('spec',$spec);
    	//print_r($listcsp);
    	
    	//摧荐商品
    	$wheres = ['cid'=>$ginf['cid']];
    	$listchot = db('good')->where($wheres)->limit(6)->select();
    	$this->assign('listchot',$listchot);
    	
    	//拼购在购数据整理
    	if($ginf['group']){
    		
    		/*拼单用户表：porder_users，无数据时，
    		 * 取 默认拼单用户表：porder_dusers 数据
    		 */
    		
    		
    		//拼单用->orderRaw('rand()')
    		$orderuds = db('porder_dusers')->where('endhour',['>',10])->order('rand()')->limit(10)->select();
    		$ouidarr = getArrOne($orderuds,'id');
    		$orderlists = db('porder_dusers')->where('id',['in',$ouidarr])->order('endhour asc,endmin asc')->limit(10)->select();
    		
    		//正在拼单用户
    		foreach ($orderlists as $k=>$v){
    			
    			$orderlists[$k]['endtimes'] = date('Y-m-d '.$v['endhour'].':'.$v['endmin'].':d');
    			unset($orderlists[$k]['endhour']);
    			unset($orderlists[$k]['endmin']);
    			unset($orderlists[$k]['id']);
    		}
    		$this->assign('orderlists',$orderlists);
    		
    		
    		//拼单成功
    		$orderuend = db('porder_dusers')->field('username,uicon')->order('rand()')->limit(20)->select();
    		$this->assign('orderuend',$orderuend);
    	}
    	
    	
    	//网站SEO标题
    	$keywords = $description = '租书会，专注中小学周边采购。主营：中小学教辅资料、中小学课外读物、文具、校服等';
    	$webseo = ['title'=>$ginf['name'].'-租书会','keywords'=>$keywords,'description'=>$description];
    	$this->assign('webseo',$webseo);
 
    	return ($ginf['group']==1)?view('pingo'):view('inf');
    }
    
}